from pathlib import Path

CONFIG_PATH = Path(__file__).resolve().parents[1] / "config" / "config.yaml"
import hashlib
import requests
import os
import time
import json
from collections import deque
from dotenv import load_dotenv
import yaml

load_dotenv()

API_KEY = os.getenv("VT_API_KEY")
VT_URL = "https://www.virustotal.com/api/v3/files/"

headers = {
    "x-apikey": API_KEY
}

# Load settings from config.yaml (with safe defaults)
def _load_config():
    cfg = {}
    try:
        with open(CONFIG_PATH, "r"), "r", encoding="utf-8") as f:
            cfg = yaml.safe_load(f) or {}
    except Exception:
        pass
    ttl_min = int(cfg.get("vt_cache_ttl_minutes", 60))
    cache_path = cfg.get("vt_cache_file", "vt_cache.json")
    rate_per_min = int(cfg.get("vt_rate_limit_per_min", 10))
    return ttl_min, cache_path, rate_per_min

_VT_TTL_MINUTES, _VT_CACHE_PATH, _VT_RATE_PER_MIN = _load_config()
_vt_cache = None
_vt_times = deque(maxlen=120)

def _load_cache():
    global _vt_cache
    if _vt_cache is not None:
        return _vt_cache
    try:
        if os.path.exists(_VT_CACHE_PATH):
            with open(_VT_CACHE_PATH, "r", encoding="utf-8") as f:
                _vt_cache = json.load(f)
        else:
            _vt_cache = {}
    except Exception:
        _vt_cache = {}
    return _vt_cache

def _save_cache():
    try:
        with open(_VT_CACHE_PATH, "w", encoding="utf-8") as f:
            json.dump(_vt_cache or {}, f)
    except Exception:
        pass

def get_file_hash(file_path):
    """Calculate the SHA256 hash of the given file."""
    try:
        with open(file_path, "rb") as f:
            file_data = f.read()
            return hashlib.sha256(file_data).hexdigest()
    except Exception as e:
        print(f"❌ Error hashing file: {e}")
        return None

def check_virustotal(file_hash):
    """Check the hash against VirusTotal API with cache and rate limiting.

    Returns: (bool|None verdict, dict stats)
      True -> malicious, False -> clean, None -> unknown/error
    """
    # Cache lookup
    cache = _load_cache()
    now = time.time()
    entry = cache.get(file_hash)
    if entry and (now - entry.get("ts", 0) <= _VT_TTL_MINUTES * 60):
        verdict = entry.get("verdict")
        stats = entry.get("stats", {})
        return verdict, stats

    # Rate limiting (per minute)
    while _vt_times and now - _vt_times[0] > 60:
        _vt_times.popleft()
    if len(_vt_times) >= _VT_RATE_PER_MIN:
        # Defer: treat as unknown for now
        return None, {}

    try:
        _vt_times.append(now)
        response = requests.get(VT_URL + file_hash, headers=headers, timeout=10)
        if response.status_code == 200:
            data = response.json()
            stats = data["data"]["attributes"]["last_analysis_stats"]
            malicious_count = stats.get("malicious", 0)
            verdict = True if malicious_count > 0 else False
            cache[file_hash] = {"verdict": verdict, "stats": stats, "ts": now}
            _save_cache()
            return verdict, stats
        elif response.status_code == 404:
            cache[file_hash] = {"verdict": None, "stats": {}, "ts": now}
            _save_cache()
            return None, {}
        else:
            return None, {}
    except Exception:
        return None, {}